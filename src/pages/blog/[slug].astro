---
import Layout from '../../layouts/Layout.astro';
import PostContent from '../../components/blog/PostContent.astro';
import { getAllPosts, getPost } from '../../lib/client';
import PostTitle from '../../components/blog/PostTitle.astro';
import PostMetadata from '../../components/blog/PostMetadata.astro';
import CoverImage from '../../components/blog/CoverImage.astro';
import PostTags from '../../components/blog/PostTags.astro';

export async function getStaticPaths() {
    const data = await getAllPosts();
    const allPosts = data.publication.posts.edges;

    // Sort posts by published date (newest first)
    const sortedPosts = [...allPosts].sort((a, b) =>
        new Date(b.node.publishedAt).getTime() - new Date(a.node.publishedAt).getTime()
    );

    return sortedPosts.map((post, index) => {
        // Previous post is newer (lower index), next post is older (higher index)
        const prevPost = index > 0 ? sortedPosts[index - 1].node : null;
        const nextPost = index < sortedPosts.length - 1 ? sortedPosts[index + 1].node : null;

        return {
            params: { slug: post.node.slug },
            props: {
                prevPost: prevPost ? { title: prevPost.title, slug: prevPost.slug } : null,
                nextPost: nextPost ? { title: nextPost.title, slug: nextPost.slug } : null
            }
        };
    });
}

const { slug } = Astro.params;
const { prevPost, nextPost } = Astro.props;
const post = await getPost(slug);
---

<Layout title={post.title}>
    <article class="w-full mx-auto flex flex-col gap-4 max-w-full">
        <header class="flex flex-col gap-8">
            <div class="dark:bg-zinc-700 bg-zinc-200 p-8 rounded-md flex flex-col gap-4 border-l-8 border-zinc-600 dark:border-zinc-400">
                <PostTitle {post} />
                <PostTags {post} />
                <PostMetadata {post} />
            </div>
        </header>
        <CoverImage {post} />
        <PostContent {post} />

        <nav class="flex justify-between items-center mt-12 pt-8 border-t border-zinc-300 dark:border-zinc-700">
            {prevPost ? (
                <a
                    href={`/blog/${prevPost.slug}`}
                    class="flex flex-col gap-1 text-left hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                >
                    <span class="text-sm text-zinc-500 dark:text-zinc-400">← Previous Post</span>
                    <span class="font-medium">{prevPost.title}</span>
                </a>
            ) : (
                <div></div>
            )}

            {nextPost ? (
                <a
                    href={`/blog/${nextPost.slug}`}
                    class="flex flex-col gap-1 text-right hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                >
                    <span class="text-sm text-zinc-500 dark:text-zinc-400">Next Post →</span>
                    <span class="font-medium">{nextPost.title}</span>
                </a>
            ) : (
                <div></div>
            )}
        </nav>
    </article>
</Layout>
